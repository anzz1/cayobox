<!DOCTYPE html>
<html>
<head>
<title>GTAV Cayo Perico Signal Box Solver</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<style>
* {
  margin:0;
  padding:0;
  overflow:hidden;
}
html, body {
  width:100%;
  height:100%;
}
body {
  background:#000;
}
#loadink {
  position:absolute;
  right:0;
  left:0;
  background:url('img/loadink.gif') no-repeat center center;
  width:498px;
  height:379px;
  margin:0 auto;
}
#wrap {
  position:relative;
  margin:0 auto;
}
#codebox {
  position:relative;
  width:1213px;
  height:937px;
  background:url('img/codebox.png') no-repeat center center;
  transform-origin:top left;
  margin:auto;
  display:none;
}
.multiplier {
  position:absolute;
  left:997px;
  bottom:0;
  right:0;
  width:78px;
  height:78px;
  cursor:pointer;
}
#m0{
  top:196px;
  background-image:url('img/1x.png');
}
#m1{
  top:432px;
  background-image:url('img/1x.png');
}
#m2{
  top:666px;
  background-image:url('img/1x.png');
}
.numero {
  position:absolute;
  left:131px;
  bottom:0;
  right:0;
  width:64px;
  height:96px;
  cursor:pointer;
}
#n0{
  top:190px;
}
#n1{
  top:426px;
}
#n2{
  top:660px;
}
.tar {
  position:absolute;
  top:42px;
  bottom:0;
  right:0;
  width:64px;
  height:96px;
  cursor:pointer;
}
#t0{
  left:485px;
}
#t1{
  left:575px;
}
#t2{
  left:665px;
}
.err {
  position:absolute;
  top:804px;
  bottom:0;
  right:0;
  width:64px;
  height:96px;
  cursor:pointer;
  display:none;
}
#e0{
  left:485px;
  background-image:url('img/re.png');
}
#e1{
  left:575px;
  background-image:url('img/rr.png');
}
#e2{
  left:665px;
  background-image:url('img/rr.png');
}
#hi {
  position:absolute;
  left:472px;
  top:30px;
  bottom:0;
  right:0;
  width:90px;
  height:118px;
  background-image:url('img/hi.png');
}
#batt {
  position:absolute;
  left:243px;
  top:826px;
  bottom:0;
  right:0;
  width:133px;
  height:44px;
  cursor:pointer;
}
</style>
</head>
<body>

<div id="wrap">
  <div id="codebox">
    <div id="hi"></div>
    <div id="batt" onClick="solveBox();"></div>
    <div class="multiplier" id="m0" onClick="chMulti(this, 0);"></div>
    <div class="multiplier" id="m1" onClick="chMulti(this, 1);"></div>
    <div class="multiplier" id="m2" onClick="chMulti(this, 2);"></div>
    <div class="numero" id="n0" onClick="chFocus(3, true);"></div>
    <div class="numero" id="n1" onClick="chFocus(4, true);"></div>
    <div class="numero" id="n2" onClick="chFocus(5, true);"></div>
    <div class="tar" id="t0" onClick="chFocus(0, true);"></div>
    <div class="tar" id="t1" onClick="chFocus(1, true);"></div>
    <div class="tar" id="t2" onClick="chFocus(2, true);"></div>
    <div class="err" id="e0"></div>
    <div class="err" id="e1"></div>
    <div class="err" id="e2"></div>
  </div>
</div>
<div id="loadink"></div>

<script>
var g_multi = [1,1,1];
var g_num = [-1,-1,-1];
var g_tar = [-1,-1,-1];
var g_focus = 0;
var g_sound = true;
var g_loaded = false;

var g_combos = [
  [0,0,1,1,2,2], // 1-1, 2-2, 3-3
  [0,0,1,2,2,1], // 1-1, 2-3, 3-2
  [0,1,1,0,2,2], // 1-2, 2-1, 3-3
  [0,1,1,2,2,0], // 1-2, 2-3, 3-1
  [0,2,1,1,2,0], // 1-3, 2-2, 3-1
  [0,2,1,0,2,1], // 1-3, 2-1, 3-2
];

function chFocus(n, isclick) {
  g_focus = n;
  var hi = document.getElementById('hi');
  switch (n) {
    case 0:
      hi.style.left = '472px';
      hi.style.top = '30px';
      hi.style.display = 'block';
      break;
    case 1:
      hi.style.left = '561px';
      hi.style.top = '30px';
      hi.style.display = 'block';
      break;
    case 2:
      hi.style.left = '650px';
      hi.style.top = '30px';
      hi.style.display = 'block';
      break;
    case 3:
      hi.style.left = '120px';
      hi.style.top = '177px';
      hi.style.display = 'block';
      break;
    case 4:
      hi.style.left = '120px';
      hi.style.top = '410px';
      hi.style.display = 'block';
      break;
    case 5:
      hi.style.left = '120px';
      hi.style.top = '643px';
      hi.style.display = 'block';
      break;
    default:
      hi.style.display = 'none';
  }
  if (isclick) {
    playSnd("click");
  }
}

function getElem(n) {
  switch (n) {
    case 0:
      return document.getElementById('t0');
    case 1:
      return document.getElementById('t1');
    case 2:
      return document.getElementById('t2');
    case 3:
      return document.getElementById('n0');
    case 4:
      return document.getElementById('n1');
    case 5:
      return document.getElementById('n2');
    case 6:
      return document.getElementById('m0');
    case 7:
      return document.getElementById('m1');
    case 8:
      return document.getElementById('m2');
    default:
      return undefined;
  }
}

function resetBox() {
  g_multi = [1,1,1];
  g_num = [-1,-1,-1];
  g_tar = [-1,-1,-1];
  chFocus(0, false);

  for (var i = 0; i < 6; i++) {
    getElem(i).style.backgroundImage = "";
  }
  for (var i = 6; i < 9; i++) {
    getElem(i).style.backgroundImage = "url('img/1x.png')";
  }

  showErr(0);
}

function showErr(show) {
  var style = show ? 'block' : 'none';
  var e0 = document.getElementById('e0');
  var e1 = document.getElementById('e1');
  var e2 = document.getElementById('e2');
  if (show == 0) {
    var i = 0;
    for (i = 0; i < 3; i++) {
      if (g_num[i] == -1 || g_tar[i] == -1) {
        break;
      }
    }
    document.getElementById('codebox').style.backgroundImage = "url('img/codebox.png')";
    document.getElementById('batt').style.backgroundImage = (i == 3) ? "url('img/brdy.png')" : "";
  } else if (show == 1) {
    e0.style.top = "804px";
    e1.style.top = "804px";
    e2.style.top = "804px";
    e0.style.backgroundImage = "url('img/re.png')";
    e1.style.backgroundImage = "url('img/rr.png')";
    e2.style.backgroundImage = "url('img/rr.png')";
    document.getElementById('codebox').style.backgroundImage = "url('img/codebox.png')";
    document.getElementById('batt').style.backgroundImage = "url('img/berr.png')";
  } else if (show >= 2) {
    e0.style.top = "803px";
    e1.style.top = "803px";
    e2.style.top = "803px";
    e0.style.backgroundImage = "url('img/w"+g_tar[0]+".png')";
    e1.style.backgroundImage = "url('img/w"+g_tar[1]+".png')";
    e2.style.backgroundImage = "url('img/w"+g_tar[2]+".png')";
    document.getElementById('codebox').style.backgroundImage = "url('img/res"+(show-2)+".png')";
    document.getElementById('batt').style.backgroundImage = "url('img/bok.png')";
  }
  e0.style.display = style;
  e1.style.display = style;
  e2.style.display = style;
}

function chMulti(elem, n) {
  switch (g_multi[n]) {
    case 2:
      g_multi[n] = 10;
      elem.style.backgroundImage = "url('img/10x.png')";
      break;
    case 10:
      g_multi[n] = 1;
      elem.style.backgroundImage = "url('img/1x.png')";
      break;
    default:
      g_multi[n] = 2;
      elem.style.backgroundImage = "url('img/2x.png')";
      break;
  }
  showErr(0);
  playSnd("thump");
  //console.log("g_multi["+n+"] = " + g_multi[n]);
}

function chNum(n, val) {
  if (val >= 1 && val <= 9) {
    g_num[n] = val;
    getElem(n+3).style.backgroundImage = "url('img/w"+val+".png')";
  } else {
    g_num[n] = -1;
    getElem(n+3).style.backgroundImage = "";
  }
  showErr(0);
  //console.log("g_num["+n+"] = " + g_num[n]);
}

function chTar(n, val) {
  if (val >= 0 && val <= 9) {
    g_tar[n] = val;
    getElem(n).style.backgroundImage = "url('img/r"+val+".png')";
  } else {
    g_tar[n] = -1;
    getElem(n).style.backgroundImage = "";
  }
  showErr(0);
  //console.log("g_tar["+n+"] = " + g_tar[n]);
}

function solveBox() {
  for (var i = 0; i < 3; i++) {
    if (g_num[i] == -1 || g_tar[i] == -1) {
      console.log("Incomplete input");
      playSnd("moo");
      return;
    }
  }
  var t = g_tar[0]*100 + g_tar[1]*10 + g_tar[2];
  console.log("Solving target: "+t);
  var res = -1;
  for (var i = 0; i < 6; i++) {
    if (g_num[g_combos[i][0]]*g_multi[g_combos[i][1]]+g_num[g_combos[i][2]]*g_multi[g_combos[i][3]]+g_num[g_combos[i][4]]*g_multi[g_combos[i][5]] == t) {
      res = i;
      break;
    }
  }
  if (res == -1) {
    showErr(1);
    console.log("Solve Fail");
    playSnd("oof");
  } else {
    showErr(2+res);
    chFocus(6, false);
    console.log("Solve Success: "+(g_combos[res][0]+1)+"-"+(g_combos[res][1]+1)+" "+
        (g_combos[res][2]+1)+"-"+(g_combos[res][3]+1)+" "+(g_combos[res][4]+1)+"-"+(g_combos[res][5]+1));
    playSnd("mlem");
  }
}

var audioArr = [];
var audioCount = 0;

function playSnd(snd) {
  if (!g_sound) {
    return;
  }
  if (typeof(Audio) === "function") {
    if (!audioArr[audioCount]) {
      audioArr[audioCount] = new Audio();
    }
    audioArr[audioCount].src = 'snd/'+snd+'.mp3';
    var promise = audioArr[audioCount].play();
    if (promise) {
      promise.catch(function(e){console.warn("WARN: playSnd('"+snd+"') "+e);});
    }
    audioCount++;
    if (audioCount > 9) { audioCount=0; }
  } else {
    console.warn("WARN: Audio() is not a function");
  }
}

var imageArr = [];
var imageCount = 0;

function preloadImage(url)
{
  if (typeof(Image) === "function") {
    imageArr[imageCount]=new Image();
    imageArr[imageCount].onerror = function(){console.error("ERROR: preloadImage('"+url+"')");};
    imageArr[imageCount].onload = function(){
      imageCount++;
      if (imageCount == 36) {
        onpreloadcomplete();
      }
    };
    imageArr[imageCount].src=url;
  } else {
    console.error("ERROR: Image() is not a function");
  }
}

preloadImage('img/codebox.png');
preloadImage('img/1x.png');
preloadImage('img/2x.png');
preloadImage('img/10x.png');
preloadImage('img/re.png');
preloadImage('img/rr.png');
preloadImage('img/hi.png');
preloadImage('img/brdy.png');
preloadImage('img/bok.png');
preloadImage('img/berr.png');
for (var i = 0; i < 10; i++) {
  preloadImage('img/w'+i+'.png');
  preloadImage('img/r'+i+'.png');
}
for (var i = 0; i < 6; i++) {
  preloadImage('img/res'+i+'.png');
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented || !g_loaded) {
    return;
  }
  switch (event.key) {
    case "0":
    case "1":
    case "2":
    case "3":
    case "4":
    case "5":
    case "6":
    case "7":
    case "8":
    case "9":
      var k = Number(event.key);
      if (g_focus < 3) {
        chTar(g_focus, k);
        chFocus(g_focus+1, false);
        playSnd("blip");
      } else if (g_focus < 6) {
        if (k != 0) {
          chNum(g_focus-3, k);
          chFocus(g_focus+1, false);
          playSnd("blip");
        }
      }
      break;
    case "Q":
    case "q":
      chMulti(getElem(6), 0);
      break;
    case "W":
    case "w":
      chMulti(getElem(7), 1);
      break;
    case "E":
    case "e":
      chMulti(getElem(8), 2);
      break;
    case "Backspace":
      if (g_focus < 3) {
        if (g_tar[g_focus] != -1) {
          chTar(g_focus, -1);
        }
      } else if (g_focus < 6) {
        if (g_num[g_focus-3] != -1) {
          chNum(g_focus-3, -1);
        }
      }
      if (g_focus > 0) {
        chFocus(g_focus - 1, false);
      }
      playSnd("swish");
      break;
    case " ":
    case "Spacebar":
    case "Enter":
      solveBox();
      break;
    case "Delete":
    case "Del":
      resetBox();
      playSnd("swish");
      break;
    case "ArrowLeft":
      if (g_focus > 0) {
        chFocus(g_focus-1, true);
      } else {
        chFocus(5, true);
      }
      break;
    case "Tab":
    case "ArrowRight":
      if (g_focus > 4) {
        chFocus(0, true);
      } else {
        chFocus(g_focus+1, true);
      }
      break;
    case "ArrowUp":
      if (g_focus > 3) {
        chFocus(g_focus-1, true);
      } else if (g_focus == 3) {
        chFocus(0, true);
      } else {
        chFocus(5, true);
      }
      break;
    case "ArrowDown":
      if (g_focus > 4) {
        chFocus(0, true);
      } else if (g_focus > 2) {
        chFocus(g_focus+1, true);
      } else {
        chFocus(3, true);
      }
      break;
    default:
      return;
  }

  //console.log("g_focus = " + g_focus);

  event.preventDefault();
}, true);

var outer = document.getElementById('codebox'),
    wrapper = document.getElementById('wrap'),
    maxWidth  = 1213,
    maxHeight = 937;
function onpreloadcomplete() {
  document.getElementById('loadink').style.display = 'none';
  document.getElementById('codebox').style.display = 'block';
  g_loaded = true;
  maxWidth  = outer.clientWidth,
  maxHeight = outer.clientHeight;
  resize();
}
window.addEventListener("resize", resize);
function resize() {
  if (!g_loaded) {
    return;
  }
  let scale, width = window.innerWidth, height = window.innerHeight,
      isMax = width >= maxWidth && height >= maxHeight;

  scale = Math.min(width/maxWidth, height/maxHeight);
  outer.style.transform = isMax?'':'scale(' + scale + ')';
  wrapper.style.width = isMax?'':maxWidth * scale + 'px';
  wrapper.style.height = isMax?'':maxHeight * scale + 'px';
}
</script>

</body>
</html>
